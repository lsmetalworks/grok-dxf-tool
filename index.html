<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parts Builder - LS Metalworks</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <h1>LS Metalworks Parts Builder</h1>
    <div class="container">
        <div class="sidebar">
            <h2>Parts Library</h2>
            <ul id="parts-list">
                <li data-part="gear">Gear</li>
                <li data-part="rectangle">Rectangle Plate</li>
                <li data-part="gusset">Triangle Gusset</li>
                <li data-part="holedPlate">Holed Mounting Plate</li>
                <li data-part="circleBracket">Circular Bracket</li>
                <li data-part="rollCageBracket">Roll Cage Bracket</li>
            </ul>
        </div>
        <div class="preview">
            <h2>Part Preview</h2>
            <canvas id="part-preview" width="400" height="400"></canvas>
        </div>
        <div class="config">
            <h2>Customize Your Part</h2>
            <div id="config-form" style="display: none;">
                <label>Part Type: <span id="part-type"></span></label><br>
                <label for="width">Width (in): </label>
                <input type="number" id="width" min="0.1" step="0.1"><br>
                <label for="height">Height (in): </label>
                <input type="number" id="height" min="0.1" step="0.1"><br>
                <div id="hole-options" style="display: none;">
                    <label for="holeSize">Hole Diameter (in): </label>
                    <input type="number" id="holeSize" min="0.1" max="1" step="0.01" value="0.25"><br>
                    <label for="holeInset">Distance from Edge (in): </label>
                    <input type="number" id="holeInset" min="0.25" step="0.01" value="0.5"><br>
                    <label for="cornerRadius">Corner Radius (in): </label>
                    <input type="number" id="cornerRadius" min="0" max="1" step="0.01" value="0"><br>
                    <label for="tubeDiameter">Tube Diameter (in): </label>
                    <input type="number" id="tubeDiameter" min="0.5" step="0.1" value="2"><br>
                    <label for="boltPattern" id="boltPatternLabel" style="display: none;">Bolt Pattern: </label>
                    <select id="boltPattern" style="display: none;">
                        <option value="4">4-Bolt</option>
                        <option value="6">6-Bolt</option>
                    </select><br>
                </div>
                <button onclick="previewPart()">Preview</button>
                <button onclick="downloadDXF()">Download DXF</button>
            </div>
        </div>
    </div>
    <script>
        // Parts library
        const partsLibrary = {
            gear: {
                name: "Gear",
                draw: (ctx, width, height) => {
                    const radius = Math.min(width, height) / 2;
                    ctx.beginPath();
                    for (let i = 0; i < 16; i++) {
                        const angle = (i * Math.PI) / 8;
                        const r = i % 2 === 0 ? radius : radius * 0.8;
                        ctx.lineTo(
                            width / 2 + r * Math.cos(angle),
                            height / 2 + r * Math.sin(angle)
                        );
                    }
                    ctx.closePath();
                    ctx.fillStyle = "#666";
                    ctx.fill();
                },
                toDXF: (width, height) => {
                    const radius = Math.min(width, height) / 2;
                    let dxf = ["0", "SECTION", "2", "ENTITIES", "0", "POLYLINE", "8", "0", "66", "1"];
                    for (let i = 0; i < 16; i++) {
                        const angle = (i * Math.PI) / 8;
                        const r = i % 2 === 0 ? radius : radius * 0.8;
                        const x = r * Math.cos(angle);
                        const y = r * Math.sin(angle);
                        dxf.push("0", "VERTEX", "8", "0", "10", x.toString(), "20", y.toString());
                    }
                    dxf.push("0", "SEQEND", "0", "ENDSEC", "0", "EOF");
                    return dxf.join("\n");
                }
            },
            rectangle: {
                name: "Rectangle Plate",
                draw: (ctx, width, height) => {
                    console.log("Drawing rectangle with:", { width, height });
                    ctx.fillStyle = "#666";
                    ctx.fillRect(0, 0, width, height);
                },
                toDXF: (width, height) => {
                    return [
                        "0", "SECTION",
                        "2", "ENTITIES",
                        "0", "POLYLINE",
                        "8", "0",
                        "66", "1",
                        "0", "VERTEX", "8", "0", "10", "0.0", "20", "0.0",
                        "0", "VERTEX", "8", "0", "10", width.toString(), "20", "0.0",
                        "0", "VERTEX", "8", "0", "10", width.toString(), "20", height.toString(),
                        "0", "VERTEX", "8", "0", "10", "0.0", "20", height.toString(),
                        "0", "SEQEND",
                        "0", "ENDSEC",
                        "0", "EOF"
                    ].join("\n");
                }
            },
            gusset: {
                name: "Triangle Gusset",
                draw: (ctx, width, height) => {
                    ctx.beginPath();
                    ctx.moveTo(0, 0);
                    ctx.lineTo(width, 0);
                    ctx.lineTo(0, height);
                    ctx.closePath();
                    ctx.fillStyle = "#666";
                    ctx.fill();
                },
                toDXF: (width, height) => {
                    return [
                        "0", "SECTION",
                        "2", "ENTITIES",
                        "0", "POLYLINE",
                        "8", "0",
                        "66", "1",
                        "0", "VERTEX", "8", "0", "10", "0.0", "20", "0.0",
                        "0", "VERTEX", "8", "0", "10", width.toString(), "20", "0.0",
                        "0", "VERTEX", "8", "0", "10", "0.0", "20", height.toString(),
                        "0", "VERTEX", "8", "0", "10", "0.0", "20", "0.0",
                        "0", "SEQEND",
                        "0", "ENDSEC",
                        "0", "EOF"
                    ].join("\n");
                }
            },
            holedPlate: {
                name: "Holed Mounting Plate",
                draw: (ctx, width, height, holeSize, holeInset, cornerRadius) => {
                    ctx.beginPath();
                    const r = cornerRadius * 10;
                    ctx.moveTo(r, 0);
                    ctx.lineTo(width - r, 0);
                    ctx.arc(width - r, r, r, -Math.PI / 2, 0);
                    ctx.lineTo(width, height - r);
                    ctx.arc(width - r, height - r, r, 0, Math.PI / 2);
                    ctx.lineTo(r, height);
                    ctx.arc(r, height - r, r, Math.PI / 2, Math.PI);
                    ctx.lineTo(0, r);
                    ctx.arc(r, r, r, Math.PI, -Math.PI / 2);
                    ctx.closePath();
                    ctx.fillStyle = "#666";
                    ctx.fill();

                    ctx.globalCompositeOperation = "destination-out";
                    const holeRadius = (holeSize / 2) * 10;
                    const inset = holeInset * 10;
                    const holeCenters = [
                        [inset, inset],
                        [width - inset, inset],
                        [width - inset, height - inset],
                        [inset, height - inset]
                    ];

                    holeCenters.forEach(([x, y]) => {
                        ctx.beginPath();
                        ctx.arc(x, y, holeRadius, 0, Math.PI * 2);
                        ctx.fill();
                    });

                    ctx.globalCompositeOperation = "source-over";
                },
                toDXF: (width, height, holeSize, holeInset, cornerRadius) => {
                    const holeRadius = holeSize / 2;
                    const inset = holeInset;
                    let dxf = ["0", "SECTION", "2", "ENTITIES"];

                    if (cornerRadius > 0) {
                        const steps = 8;
                        dxf.push("0", "POLYLINE", "8", "0", "66", "1");
                        dxf.push("0", "VERTEX", "8", "0", "10", cornerRadius.toString(), "20", "0.0");
                        for (let i = 0; i <= steps; i++) {
                            const angle = -Math.PI / 2 + (Math.PI / 2) * (i / steps);
                            const x = width - cornerRadius + cornerRadius * Math.cos(angle);
                            const y = cornerRadius + cornerRadius * Math.sin(angle);
                            dxf.push("0", "VERTEX", "8", "0", "10", x.toString(), "20", y.toString());
                        }
                        dxf.push("0", "VERTEX", "8", "0", "10", width.toString(), "20", cornerRadius.toString());
                        for (let i = 0; i <= steps; i++) {
                            const angle = 0 + (Math.PI / 2) * (i / steps);
                            const x = width - cornerRadius + cornerRadius * Math.cos(angle);
                            const y = height - cornerRadius + cornerRadius * Math.sin(angle);
                            dxf.push("0", "VERTEX", "8", "0", "10", x.toString(), "20", y.toString());
                        }
                        dxf.push("0", "VERTEX", "8", "0", "10", (width - cornerRadius).toString(), "20", height.toString());
                        for (let i = 0; i <= steps; i++) {
                            const angle = Math.PI / 2 + (Math.PI / 2) * (i / steps);
                            const x = cornerRadius + cornerRadius * Math.cos(angle);
                            const y = height - cornerRadius + cornerRadius * Math.sin(angle);
                            dxf.push("0", "VERTEX", "8", "0", "10", x.toString(), "20", y.toString());
                        }
                        dxf.push("0", "VERTEX", "8", "0", "10", "0.0", "20", (height - cornerRadius).toString());
                        for (let i = 0; i <= steps; i++) {
                            const angle = Math.PI + (Math.PI / 2) * (i / steps);
                            const x = cornerRadius + cornerRadius * Math.cos(angle);
                            const y = cornerRadius + cornerRadius * Math.sin(angle);
                            dxf.push("0", "VERTEX", "8", "0", "10", x.toString(), "20", y.toString());
                        }
                        dxf.push("0", "VERTEX", "8", "0", "10", cornerRadius.toString(), "20", "0.0");
                        dxf.push("0", "SEQEND");
                    } else {
                        dxf.push(
                            "0", "POLYLINE", "8", "0", "66", "1",
                            "0", "VERTEX", "8", "0", "10", "0.0", "20", "0.0",
                            "0", "VERTEX", "8", "0", "10", width.toString(), "20", "0.0",
                            "0", "VERTEX", "8", "0", "10", width.toString(), "20", height.toString(),
                            "0", "VERTEX", "8", "0", "10", "0.0", "20", height.toString(),
                            "0", "SEQEND"
                        );
                    }

                    const holeCenters = [
                        [inset, inset],
                        [width - inset, inset],
                        [width - inset, height - inset],
                        [inset, height - inset]
                    ];
                    holeCenters.forEach(([x, y]) => {
                        dxf.push(
                            "0", "CIRCLE",
                            "8", "0",
                            "10", x.toString(),
                            "20", y.toString(),
                            "40", holeRadius.toString()
                        );
                    });

                    dxf.push("0", "ENDSEC", "0", "EOF");
                    return dxf.join("\n");
                }
            },
            circleBracket: {
                name: "Circular Bracket",
                draw: (ctx, width, _unusedHeight, holeSize, holeInset) => {
                    const radius = width / 2;
                    const centerX = radius;
                    const centerY = radius;
                    const holeRadius = (holeSize / 2) * 10;
                    const inset = (radius - holeInset * 10);

                    ctx.beginPath();
                    ctx.arc(centerX, centerY, radius, 0, Math.PI * 2);
                    ctx.closePath();
                    ctx.fillStyle = "#666";
                    ctx.fill();

                    if (holeSize > 0 && holeInset >= 0 && inset >= holeRadius) {
                        ctx.globalCompositeOperation = "destination-out";
                        const angles = [0, Math.PI / 2, Math.PI, 3 * Math.PI / 2];
                        angles.forEach(angle => {
                            const holeX = centerX + inset * Math.cos(angle);
                            const holeY = centerY + inset * Math.sin(angle);
                            ctx.beginPath();
                            ctx.arc(holeX, holeY, holeRadius, 0, Math.PI * 2);
                            ctx.fill();
                        });
                        ctx.globalCompositeOperation = "source-over";
                    }

                    console.log("Drawing circular bracket:", { width, holeSize, holeInset });
                },
                toDXF: (width, _unusedHeight, holeSize, holeInset) => {
                    const radius = width / 2;
                    const centerX = radius;
                    const centerY = radius;
                    const holeRadius = holeSize / 2;
                    const inset = radius - holeInset;

                    let dxf = [
                        "0", "SECTION",
                        "2", "ENTITIES",
                        "0", "CIRCLE",
                        "8", "0",
                        "10", centerX.toString(),
                        "20", centerY.toString(),
                        "40", radius.toString()
                    ];

                    if (holeSize > 0 && holeInset >= 0 && inset >= holeRadius) {
                        const angles = [0, Math.PI / 2, Math.PI, 3 * Math.PI / 2];
                        angles.forEach(angle => {
                            const holeX = centerX + inset * Math.cos(angle);
                            const holeY = centerY + inset * Math.sin(angle);
                            dxf.push(
                                "0", "CIRCLE",
                                "8", "0",
                                "10", holeX.toString(),
                                "20", holeY.toString(),
                                "40", holeRadius.toString()
                            );
                        });
                    }

                    dxf.push("0", "ENDSEC", "0", "EOF");
                    return dxf.join("\n");
                }
            },
            rollCageBracket: {
                name: "Roll Cage Bracket",
                draw: (ctx, tabWidth, height, holeSize, tubeDiameter, boltPattern) => {
                    const bracketWidth = (tubeDiameter + 2 * tabWidth) * 10; // Total width in canvas units
                    const tubeRadius = tubeDiameter * 5; // Canvas units
                    const tabWidthCanvas = tabWidth * 10;
                    const holeRadius = (holeSize / 2) * 10;

                    ctx.beginPath();
                    // Left tab
                    ctx.moveTo(0, 0);
                    ctx.lineTo(tabWidthCanvas, 0);
                    ctx.lineTo(tabWidthCanvas, height);
                    ctx.lineTo(0, height);
                    ctx.closePath();
                    // Right tab
                    ctx.moveTo(bracketWidth - tabWidthCanvas, 0);
                    ctx.lineTo(bracketWidth, 0);
                    ctx.lineTo(bracketWidth, height);
                    ctx.lineTo(bracketWidth - tabWidthCanvas, height);
                    ctx.closePath();
                    // Saddle arc
                    ctx.moveTo(tabWidthCanvas, height);
                    ctx.arc(bracketWidth / 2, height + tubeRadius, tubeRadius, Math.PI, 0, false);
                    ctx.lineTo(bracketWidth - tabWidthCanvas, height);
                    ctx.fillStyle = "#666";
                    ctx.fill();

                    if (holeSize > 0 && tabWidthCanvas > holeRadius * 2) {
                        ctx.globalCompositeOperation = "destination-out";
                        if (boltPattern === 4) {
                            // 4-bolt: 2 holes per tab, centered vertically
                            const holeY = height / 2;
                            ctx.beginPath();
                            ctx.arc(tabWidthCanvas / 2, holeY, holeRadius, 0, Math.PI * 2); // Left tab
                            ctx.fill();
                            ctx.beginPath();
                            ctx.arc(bracketWidth - tabWidthCanvas / 2, holeY, holeRadius, 0, Math.PI * 2); // Right tab
                            ctx.fill();
                        } else if (boltPattern === 6) {
                            // 6-bolt: 3 holes per tab, spaced vertically
                            const holeSpacing = height / 4;
                            [holeSpacing, holeSpacing * 2, holeSpacing * 3].forEach(holeY => {
                                ctx.beginPath();
                                ctx.arc(tabWidthCanvas / 2, holeY, holeRadius, 0, Math.PI * 2); // Left tab
                                ctx.fill();
                                ctx.beginPath();
                                ctx.arc(bracketWidth - tabWidthCanvas / 2, holeY, holeRadius, 0, Math.PI * 2); // Right tab
                                ctx.fill();
                            });
                        }
                        ctx.globalCompositeOperation = "source-over";
                    }

                    console.log("Drawing roll cage bracket:", { tabWidth, height, holeSize, tubeDiameter, boltPattern, bracketWidth });
                },
                toDXF: (tabWidth, height, holeSize, tubeDiameter, boltPattern) => {
                    const bracketWidth = tubeDiameter + 2 * tabWidth; // Total width in inches
                    const tubeRadius = tubeDiameter / 2;
                    const holeRadius = holeSize / 2;

                    let dxf = [
                        "0", "SECTION",
                        "2", "ENTITIES"
                    ];

                    // Left tab
                    dxf.push(
                        "0", "POLYLINE",
                        "8", "0",
                        "66", "1",
                        "0", "VERTEX", "8", "0", "10", "0.0", "20", "0.0",
                        "0", "VERTEX", "8", "0", "10", tabWidth.toString(), "20", "0.0",
                        "0", "VERTEX", "8", "0", "10", tabWidth.toString(), "20", height.toString(),
                        "0", "VERTEX", "8", "0", "10", "0.0", "20", height.toString(),
                        "0", "SEQEND"
                    );

                    // Right tab
                    dxf.push(
                        "0", "POLYLINE",
                        "8", "0",
                        "66", "1",
                        "0", "VERTEX", "8", "0", "10", (bracketWidth - tabWidth).toString(), "20", "0.0",
                        "0", "VERTEX", "8", "0", "10", bracketWidth.toString(), "20", "0.0",
                        "0", "VERTEX", "8", "0", "10", bracketWidth.toString(), "20", height.toString(),
                        "0", "VERTEX", "8", "0", "10", (bracketWidth - tabWidth).toString(), "20", height.toString(),
                        "0", "SEQEND"
                    );

                    // Saddle arc (approximated with polyline)
                    const steps = 16;
                    dxf.push("0", "POLYLINE", "8", "0", "66", "1");
                    dxf.push("0", "VERTEX", "8", "0", "10", tabWidth.toString(), "20", height.toString());
                    for (let i = 0; i <= steps; i++) {
                        const angle = Math.PI + (Math.PI * i) / steps;
                        const x = bracketWidth / 2 + tubeRadius * Math.cos(angle);
                        const y = height + tubeRadius + tubeRadius * Math.sin(angle);
                        dxf.push("0", "VERTEX", "8", "0", "10", x.toString(), "20", y.toString());
                    }
                    dxf.push("0", "VERTEX", "8", "0", "10", (bracketWidth - tabWidth).toString(), "20", height.toString());
                    dxf.push("0", "SEQEND");

                    if (holeSize > 0 && tabWidth > holeRadius * 2) {
                        if (boltPattern === 4) {
                            const holeY = height / 2;
                            dxf.push(
                                "0", "CIRCLE", "8", "0", "10", (tabWidth / 2).toString(), "20", holeY.toString(), "40", holeRadius.toString(),
                                "0", "CIRCLE", "8", "0", "10", (bracketWidth - tabWidth / 2).toString(), "20", holeY.toString(), "40", holeRadius.toString()
                            );
                        } else if (boltPattern === 6) {
                            const holeSpacing = height / 4;
                            [holeSpacing, holeSpacing * 2, holeSpacing * 3].forEach(holeY => {
                                dxf.push(
                                    "0", "CIRCLE", "8", "0", "10", (tabWidth / 2).toString(), "20", holeY.toString(), "40", holeRadius.toString(),
                                    "0", "CIRCLE", "8", "0", "10", (bracketWidth - tabWidth / 2).toString(), "20", holeY.toString(), "40", holeRadius.toString()
                                );
                            });
                        }
                    }

                    dxf.push("0", "ENDSEC", "0", "EOF");
                    return dxf.join("\n");
                }
            }
        };

        // Ensure DOM is loaded before adding event listeners
        document.addEventListener("DOMContentLoaded", () => {
            console.log("DOM fully loaded, setting up event listeners");

            const partItems = document.querySelectorAll("#parts-list li");
            console.log("Found parts-list items:", partItems.length);

            if (partItems.length === 0) {
                console.error("No elements found with selector '#parts-list li'. Check HTML structure.");
                return;
            }

            partItems.forEach(item => {
                item.addEventListener("click", () => {
                    const partType = item.getAttribute("data-part");
                    console.log("Clicked part:", partType);
                    const configForm = document.getElementById("config-form");
                    if (!configForm) {
                        console.error("Config form not found!");
                        return;
                    }
                    configForm.style.display = "block";
                    document.getElementById("part-type").textContent = partsLibrary[partType].name;
                    document.getElementById("width").value = "";
                    document.getElementById("height").value = "";
                    document.getElementById("hole-options").style.display = (partType === "holedPlate" || partType === "circleBracket" || partType === "rollCageBracket") ? "block" : "none";
                    if (partType === "holedPlate") {
                        document.getElementById("holeSize").value = "0.25";
                        document.getElementById("holeInset").value = "0.5";
                        document.getElementById("cornerRadius").value = "0";
                        document.getElementById("tubeDiameter").value = "2";
                        document.getElementById("holeInset").style.display = "block";
                        document.getElementById("cornerRadius").style.display = "block";
                        document.getElementById("tubeDiameter").style.display = "none";
                        document.getElementById("boltPatternLabel").style.display = "none";
                        document.getElementById("boltPattern").style.display = "none";
                        document.getElementById("holeInset").previousElementSibling.style.display = "block";
                        document.getElementById("cornerRadius").previousElementSibling.style.display = "block";
                        document.getElementById("tubeDiameter").previousElementSibling.style.display = "none";
                    } else if (partType === "circleBracket") {
                        document.getElementById("holeSize").value = "0.25";
                        document.getElementById("holeInset").value = "0.5";
                        document.getElementById("cornerRadius").value = "0";
                        document.getElementById("tubeDiameter").value = "2";
                        document.getElementById("cornerRadius").style.display = "none";
                        document.getElementById("holeInset").style.display = "block";
                        document.getElementById("tubeDiameter").style.display = "none";
                        document.getElementById("boltPatternLabel").style.display = "none";
                        document.getElementById("boltPattern").style.display = "none";
                        document.getElementById("holeInset").previousElementSibling.style.display = "block";
                        document.getElementById("cornerRadius").previousElementSibling.style.display = "none";
                        document.getElementById("tubeDiameter").previousElementSibling.style.display = "none";
                    } else if (partType === "rollCageBracket") {
                        document.getElementById("width").previousElementSibling.textContent = "Tab Width (in): ";
                        document.getElementById("holeSize").value = "0.25";
                        document.getElementById("holeInset").value = "0.5";
                        document.getElementById("cornerRadius").value = "0";
                        document.getElementById("tubeDiameter").value = "2";
                        document.getElementById("holeInset").style.display = "none";
                        document.getElementById("cornerRadius").style.display = "none";
                        document.getElementById("tubeDiameter").style.display = "block";
                        document.getElementById("boltPatternLabel").style.display = "block";
                        document.getElementById("boltPattern").style.display = "block";
                        document.getElementById("holeInset").previousElementSibling.style.display = "none";
                        document.getElementById("cornerRadius").previousElementSibling.style.display = "none";
                        document.getElementById("tubeDiameter").previousElementSibling.style.display = "block";
                    } else {
                        document.getElementById("width").previousElementSibling.textContent = "Width (in): ";
                        document.getElementById("boltPatternLabel").style.display = "none";
                        document.getElementById("boltPattern").style.display = "none";
                    }
                    console.log("Part selected:", partType);
                });
            });
        });

        // Preview the part on canvas
        function previewPart() {
            const partType = document.getElementById("part-type").textContent;
            const widthInput = parseFloat(document.getElementById("width").value); // Width or tabWidth
            const height = partType !== "Circular Bracket" ? parseFloat(document.getElementById("height").value) * 10 : widthInput * 10;
            const holeSize = (partType === "Holed Mounting Plate" || partType === "Circular Bracket" || partType === "Roll Cage Bracket") ? parseFloat(document.getElementById("holeSize").value || 0) : 0;
            const holeInset = (partType === "Holed Mounting Plate" || partType === "Circular Bracket") ? parseFloat(document.getElementById("holeInset").value || 0.5) : 0;
            const cornerRadius = partType === "Holed Mounting Plate" ? parseFloat(document.getElementById("cornerRadius").value || 0) : 0;
            const tubeDiameter = partType === "Roll Cage Bracket" ? parseFloat(document.getElementById("tubeDiameter").value || 2) : 0;
            const boltPattern = partType === "Roll Cage Bracket" ? parseInt(document.getElementById("boltPattern").value) : 0;

            // For rollCageBracket, widthInput is tabWidth; calculate total bracketWidth
            const width = partType === "Roll Cage Bracket" ? (tubeDiameter + 2 * widthInput) * 10 : widthInput * 10;

            console.log("Previewing:", { partType, widthInput, width, height, holeSize, holeInset, cornerRadius, tubeDiameter, boltPattern });

            if (!widthInput || widthInput <= 0 || 
                (partType !== "Circular Bracket" && (!height || isNaN(height) || height <= 0)) || 
                ((partType === "Holed Mounting Plate" || partType === "Circular Bracket" || partType === "Roll Cage Bracket") && (!holeSize || isNaN(holeSize) || holeSize <= 0)) || 
                ((partType === "Holed Mounting Plate" || partType === "Circular Bracket") && (!holeInset || isNaN(holeInset) || holeInset < 0)) || 
                (partType === "Holed Mounting Plate" && (isNaN(cornerRadius) || cornerRadius < 0)) || 
                (partType === "Roll Cage Bracket" && (!tubeDiameter || isNaN(tubeDiameter) || tubeDiameter <= 0))) {
                alert("Please enter valid positive values for all required fields.");
                console.log("Validation failed:", { widthInput, height, holeSize, holeInset, cornerRadius, tubeDiameter });
                return;
            }

            const canvas = document.getElementById("part-preview");
            if (!canvas) {
                console.error("Canvas element 'part-preview' not found!");
                return;
            }
            console.log("Canvas found:", { width: canvas.width, height: canvas.height });

            const ctx = canvas.getContext("2d");
            if (!ctx) {
                console.error("Failed to get 2D context from canvas!");
                return;
            }
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            const part = Object.values(partsLibrary).find(p => p.name === partType);
            if (part) {
                ctx.save();
                const translateX = 200 - width / 2;
                const translateY = partType === "Circular Bracket" ? 200 - width / 2 : 200 - height - (partType === "Roll Cage Bracket" ? tubeDiameter * 5 : 0);
                ctx.translate(translateX, translateY);
                console.log("Canvas translation:", { x: translateX, y: translateY });
                try {
                    if (partType === "Holed Mounting Plate") {
                        part.draw(ctx, width, height, holeSize, holeInset, cornerRadius);
                    } else if (partType === "Circular Bracket") {
                        part.draw(ctx, width, height, holeSize, holeInset);
                    } else if (partType === "Roll Cage Bracket") {
                        part.draw(ctx, widthInput * 10, height, holeSize, tubeDiameter, boltPattern);
                    } else {
                        part.draw(ctx, width, height);
                    }
                    console.log("Preview drawn successfully for", partType);
                } catch (error) {
                    console.error("Error drawing preview:", error);
                }
                ctx.restore();
            } else {
                console.log("Part not found:", partType);
            }
        }

        // Download DXF file
        function downloadDXF() {
            const partType = document.getElementById("part-type").textContent;
            const widthInput = parseFloat(document.getElementById("width").value);
            const height = partType !== "Circular Bracket" ? parseFloat(document.getElementById("height").value) : widthInput;
            const holeSize = (partType === "Holed Mounting Plate" || partType === "Circular Bracket" || partType === "Roll Cage Bracket") ? parseFloat(document.getElementById("holeSize").value || 0) : 0;
            const holeInset = (partType === "Holed Mounting Plate" || partType === "Circular Bracket") ? parseFloat(document.getElementById("holeInset").value || 0.5) : 0;
            const cornerRadius = partType === "Holed Mounting Plate" ? parseFloat(document.getElementById("cornerRadius").value || 0) : 0;
            const tubeDiameter = partType === "Roll Cage Bracket" ? parseFloat(document.getElementById("tubeDiameter").value || 2) : 0;
            const boltPattern = partType === "Roll Cage Bracket" ? parseInt(document.getElementById("boltPattern").value) : 0;

            // For rollCageBracket, widthInput is tabWidth; calculate total bracketWidth
            const width = partType === "Roll Cage Bracket" ? tubeDiameter + 2 * widthInput : widthInput;

            if (!widthInput || widthInput <= 0 || 
                (partType !== "Circular Bracket" && (!height || isNaN(height) || height <= 0)) || 
                ((partType === "Holed Mounting Plate" || partType === "Circular Bracket" || partType === "Roll Cage Bracket") && (!holeSize || isNaN(holeSize) || holeSize <= 0)) || 
                ((partType === "Holed Mounting Plate" || partType === "Circular Bracket") && (!holeInset || isNaN(holeInset) || holeInset < 0)) || 
                (partType === "Holed Mounting Plate" && (isNaN(cornerRadius) || cornerRadius < 0)) || 
                (partType === "Roll Cage Bracket" && (!tubeDiameter || isNaN(tubeDiameter) || tubeDiameter <= 0))) {
                alert("Please enter valid positive values for all required fields.");
                return;
            }

            const part = Object.values(partsLibrary).find(p => p.name === partType);
            if (part) {
                const dxfContent = partType === "Holed Mounting Plate" ? part.toDXF(width, height, holeSize, holeInset, cornerRadius) :
                                  partType === "Circular Bracket" ? part.toDXF(width, height, holeSize, holeInset) :
                                  partType === "Roll Cage Bracket" ? part.toDXF(widthInput, height, holeSize, tubeDiameter, boltPattern) :
                                  part.toDXF(width, height);
                if (dxfContent) {
                    const blob = new Blob([dxfContent], { type: "application/dxf" });
                    const link = document.createElement("a");
                    link.href = URL.createObjectURL(blob);
                    link.download = `${partType.toLowerCase()}.dxf`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                } else {
                    console.log("DXF generation skipped due to invalid parameters.");
                }
            }
        }
    </script>
</body>
</html>
